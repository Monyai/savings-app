name: Claude Code AI Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main, develop]

jobs:
  ai-review:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install Claude Code
      run: |
        npm install -g @anthropic-ai/claude-code

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.16.0'

    - name: AI Code Review
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      run: |
        echo "ü§ñ Claude Code AI Review Starting..."
        
        # PRÊÉÖÂ†±ÂèñÂæó
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          PR_NUMBER=${{ github.event.number }}
          echo "Reviewing PR #$PR_NUMBER"
          
          # Claude Code „Åß„É¨„Éì„É•„ÉºÂÆüË°å
          claude << 'CLAUDE_PROMPT'
          GitHub MCP„Çí‰ΩøÁî®„Åó„Å¶PR #$PR_NUMBER „Çí„É¨„Éì„É•„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          
          „ÉÅ„Çß„ÉÉ„ÇØÈ†ÖÁõÆ:
          1. Flutter/Dart „Ç≥„Éº„Éá„Ç£„É≥„Ç∞Ë¶èÁ¥ÑÊ∫ñÊã†
          2. Material 3 Design „Ç¨„Ç§„Éâ„É©„Ç§„É≥ÈÅ©Âêà
          3. „ÉÜ„Çπ„Éà„Ç´„Éê„É¨„ÉÉ„Ç∏Á¢∫Ë™ç
          4. „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÂΩ±ÈüøË©ï‰æ°
          5. „Çª„Ç≠„É•„É™„ÉÜ„Ç£ËÑÜÂº±ÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
          
          „É¨„Éì„É•„ÉºÂÆå‰∫ÜÂæå„ÄÅ‰ª•‰∏ã„ÇíÂÆüË°å:
          - ÈÅ©Âàá„Å™„Ç≥„É°„É≥„Éà„ÅßPR„É¨„Éì„É•„Éº
          - Slack #savings-app-dev „Å´ÁµêÊûúÂ†±Âëä
          
          ÈáçË¶Å„Å™ÂïèÈ°åÁô∫Ë¶ãÊôÇ„ÅØSlack #savings-app-alerts „Å´„ÇÇÈÄöÁü•
CLAUDE_PROMPT
        fi

    - name: Notify Slack on Success
      if: success()
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"‚úÖ AI ReviewÂÆå‰∫Ü: ${{ github.event.head_commit.message || github.event.pull_request.title }}"}' \
        ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Notify Slack on Failure  
      if: failure()
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"‚ùå AI ReviewÂ§±Êïó: ${{ github.event.head_commit.message || github.event.pull_request.title }}"}' \
        ${{ secrets.SLACK_WEBHOOK_URL }}
