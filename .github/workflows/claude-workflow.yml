name: Claude Code Savings App Workflow

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚’å¯èƒ½ã«ã™ã‚‹

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      
      # 2. Node.jsç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆClaude Codeç”¨ï¼‰
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # 3. Flutterç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã‚¢ãƒ—ãƒªé–‹ç™ºç”¨ï¼‰
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.4'
          channel: 'stable'
      
      # 4. Claude Codeç’°å¢ƒã®è¨­å®š
      - name: Setup Claude Code Environment
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_WEBHOOK_URL_DEV: ${{ secrets.SLACK_WEBHOOK_URL_DEV }}
          SLACK_WEBHOOK_URL_ALERTS: ${{ secrets.SLACK_WEBHOOK_URL_ALERTS }}
          SLACK_WEBHOOK_URL_RELEASES: ${{ secrets.SLACK_WEBHOOK_URL_RELEASES }}
        run: |
          echo "ğŸš€ Claude Codeç’°å¢ƒè¨­å®šé–‹å§‹"
          echo "Node.js version: $(node --version)"
          echo "Flutter version: $(flutter --version | head -1)"
          echo "ç’°å¢ƒå¤‰æ•°è¨­å®šå®Œäº†"
      
      # 5. ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: |
          echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
          # Flutterä¾å­˜é–¢ä¿‚
          if [ -f "pubspec.yaml" ]; then
            flutter pub get
          fi
          # npmä¾å­˜é–¢ä¿‚ï¼ˆã‚‚ã—å­˜åœ¨ã™ã‚‹å ´åˆï¼‰
          if [ -f "package.json" ]; then
            npm install
          fi
      
      # 6. ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
      - name: Run code analysis
        run: |
          echo "ğŸ” ã‚³ãƒ¼ãƒ‰è§£æå®Ÿè¡Œ"
          if [ -f "pubspec.yaml" ]; then
            flutter analyze
          fi
      
      # 7. ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
      - name: Run tests
        run: |
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
          if [ -f "pubspec.yaml" ]; then
            flutter test
          fi
      
      # 8. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰
      - name: Build application
        run: |
          echo "ğŸ”¨ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰"
          if [ -f "pubspec.yaml" ]; then
            # Webç‰ˆã®ãƒ“ãƒ«ãƒ‰
            flutter build web
            echo "Webç‰ˆãƒ“ãƒ«ãƒ‰å®Œäº†"
          fi
      
      # 9. æˆåŠŸæ™‚ã®Slacké€šçŸ¥
      - name: Notify Slack - Success
        if: success()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL_DEV }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "âœ… *Savings App* - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æˆåŠŸ",
              "attachments": [
                {
                  "color": "good",
                  "fields": [
                    {"title": "Repository", "value": "${{ github.repository }}", "short": true},
                    {"title": "Branch", "value": "${{ github.ref_name }}", "short": true},
                    {"title": "Commit", "value": "`${{ github.sha }}`", "short": true},
                    {"title": "Author", "value": "${{ github.actor }}", "short": true}
                  ]
                }
              ]
            }' \
            $SLACK_WEBHOOK_URL
      
      # 10. å¤±æ•—æ™‚ã®Slacké€šçŸ¥
      - name: Notify Slack - Failure
        if: failure()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL_ALERTS }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "âŒ *Savings App* - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å¤±æ•—",
              "attachments": [
                {
                  "color": "danger",
                  "fields": [
                    {"title": "Repository", "value": "${{ github.repository }}", "short": true},
                    {"title": "Branch", "value": "${{ github.ref_name }}", "short": true},
                    {"title": "Commit", "value": "`${{ github.sha }}`", "short": true},
                    {"title": "Author", "value": "${{ github.actor }}", "short": true},
                    {"title": "Workflow", "value": "[View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "short": false}
                  ]
                }
              ]
            }' \
            $SLACK_WEBHOOK_URL
